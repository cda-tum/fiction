name: Clang-Tidy Review

on:
  pull_request:
    branches: ["main"]
    paths:
      - "**/*.hpp"
      - "**/*.cpp"
      - ".github/workflows/clang-tidy-review.yml"
      - "!bindings/mnt/pyfiction/include/pyfiction/pybind11_mkdoc_docstrings.hpp"
      - "!bindings/mnt/pyfiction/include/pyfiction/documentation.hpp"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  Z3_VERSION: 4.13.4

jobs:
  clangtidy:
    runs-on: ubuntu-latest
    name: ðŸš¨ Clang-Tidy

    steps:
      - name: Clone Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libreadline-dev libtbb-dev python3-dev

      - name: Setup Z3 Solver
        id: z3
        uses: cda-tum/setup-z3@8156b32632230f11cf9c5a50becb33d73e2fb4e5 # v1.7.1
        with:
          version: ${{env.Z3_VERSION}}
          platform: linux
          architecture: x64
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Generate compilation database
        run: >
          cmake -B build -S .
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DFICTION_CLI=ON
          -DFICTION_TEST=ON
          -DFICTION_BENCHMARK=ON
          -DFICTION_EXPERIMENTS=ON
          -DFICTION_PROGRESS_BARS=ON
          -DFICTION_PYTHON_BINDINGS=ON
          -DFICTION_Z3=ON
          -DFICTION_ENABLE_MUGEN=ON
          -DFICTION_ALGLIB=ON
          -DMOCKTURTLE_EXAMPLES=OFF

      - name: Run clang-tidy
        id: linter
        uses: cpp-linter/cpp-linter-action@b6edc0625e3941baa1797f4b4326adeab6890c97 # v2.16.7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          style: ""
          tidy-checks: ""
          database: "build"
          step-summary: true
          thread-comments: ${{ ((github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork) && 'update') || 'false' }}
          ignore: "build|libs/*|vendors/*|docs/*|benchmarks/*|bib/*|bindings/mnt/pyfiction/include/pyfiction/pybind11_mkdoc_docstrings.hpp|bindings/mnt/pyfiction/include/pyfiction/documentation.hpp"
          version: "21"

      - if: steps.linter.outputs.checks-failed > 0
        run: exit 1
