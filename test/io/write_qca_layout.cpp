//
// Created by marcel on 24.09.21.
//

#include <catch2/catch_test_macros.hpp>

#include "utils/version_info.hpp"

#include <fiction/io/write_qca_layout.hpp>
#include <fiction/layouts/cartesian_layout.hpp>
#include <fiction/layouts/cell_level_layout.hpp>
#include <fiction/layouts/clocked_layout.hpp>
#include <fiction/technology/cell_technologies.hpp>

#include <fmt/format.h>

#include <sstream>
#include <string>

using namespace fiction;

TEST_CASE("Write empty QCAD layout", "[qcad]")
{
    using qca_layout = cell_level_layout<qca_technology, clocked_layout<cartesian_layout<offset::ucoord_t>>>;

    qca_layout layout{{2, 2, 1}, "empty layout"};

    SECTION("with vias")
    {
        static const std::string qcad_layout = fmt::format("[VERSION]\n"
                                                           "qcadesigner_version=2.000000\n"
                                                           "[#VERSION]\n"
                                                           "[LAYOUT]\n"
                                                           "name=empty layout\n"
                                                           "generated_by={}\n"
                                                           "repo={}\n"
                                                           "[#LAYOUT]\n"
                                                           "[TYPE:DESIGN]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=3\n"
                                                           "status=1\n"
                                                           "pszDescription=Drawing Layer\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=0\n"
                                                           "status=1\n"
                                                           "pszDescription=Substrate\n"
                                                           "[TYPE:QCADSubstrate]\n"
                                                           "[TYPE:QCADStretchyObject]\n"
                                                           "[TYPE:QCADDesignObject]\n"
                                                           "x=3000.000000\n"
                                                           "y=1500.000000\n"
                                                           "bSelected=FALSE\n"
                                                           "clr.red=65535\n"
                                                           "clr.green=65535\n"
                                                           "clr.blue=65535\n"
                                                           "bounding_box.xWorld=0.000000\n"
                                                           "bounding_box.yWorld=0.000000\n"
                                                           "bounding_box.cxWorld=6000.000000\n"
                                                           "bounding_box.cyWorld=3000.000000\n"
                                                           "[#TYPE:QCADDesignObject]\n"
                                                           "[#TYPE:QCADStretchyObject]\n"
                                                           "grid_spacing=20.000000\n"
                                                           "[#TYPE:QCADSubstrate]\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=1\n"
                                                           "status=0\n"
                                                           "pszDescription=Ground Layer\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=1\n"
                                                           "status=0\n"
                                                           "pszDescription=Crossing Layer 1\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[#TYPE:DESIGN]\n",
                                                           FICTION_VERSION, FICTION_REPO);

        std::ostringstream layout_stream{};

        write_qca_layout(layout, layout_stream, {true});

        CHECK(layout_stream.str() == qcad_layout);
    }
    SECTION("without vias")
    {
        static const std::string qcad_layout = fmt::format("[VERSION]\n"
                                                           "qcadesigner_version=2.000000\n"
                                                           "[#VERSION]\n"
                                                           "[LAYOUT]\n"
                                                           "name=empty layout\n"
                                                           "generated_by={}\n"
                                                           "repo={}\n"
                                                           "[#LAYOUT]\n"
                                                           "[TYPE:DESIGN]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=3\n"
                                                           "status=1\n"
                                                           "pszDescription=Drawing Layer\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=0\n"
                                                           "status=1\n"
                                                           "pszDescription=Substrate\n"
                                                           "[TYPE:QCADSubstrate]\n"
                                                           "[TYPE:QCADStretchyObject]\n"
                                                           "[TYPE:QCADDesignObject]\n"
                                                           "x=3000.000000\n"
                                                           "y=1500.000000\n"
                                                           "bSelected=FALSE\n"
                                                           "clr.red=65535\n"
                                                           "clr.green=65535\n"
                                                           "clr.blue=65535\n"
                                                           "bounding_box.xWorld=0.000000\n"
                                                           "bounding_box.yWorld=0.000000\n"
                                                           "bounding_box.cxWorld=6000.000000\n"
                                                           "bounding_box.cyWorld=3000.000000\n"
                                                           "[#TYPE:QCADDesignObject]\n"
                                                           "[#TYPE:QCADStretchyObject]\n"
                                                           "grid_spacing=20.000000\n"
                                                           "[#TYPE:QCADSubstrate]\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=1\n"
                                                           "status=0\n"
                                                           "pszDescription=Ground Layer\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[TYPE:QCADLayer]\n"
                                                           "type=1\n"
                                                           "status=0\n"
                                                           "pszDescription=Crossing Layer 1\n"
                                                           "[#TYPE:QCADLayer]\n"
                                                           "[#TYPE:DESIGN]\n",
                                                           FICTION_VERSION, FICTION_REPO);

        std::ostringstream layout_stream{};

        write_qca_layout(layout, layout_stream, {false});

        CHECK(layout_stream.str() == qcad_layout);
    }
}

TEST_CASE("Write single-layer QCAD AND gate", "[qcad]")
{
    using qca_layout = cell_level_layout<qca_technology, clocked_layout<cartesian_layout<offset::ucoord_t>>>;

    qca_layout layout{{4, 4}, "AND"};

    layout.assign_cell_type({0, 2}, qca_technology::cell_type::INPUT);
    layout.assign_cell_type({2, 4}, qca_technology::cell_type::INPUT);
    layout.assign_cell_type({2, 0}, qca_technology::cell_type::CONST_0);
    layout.assign_cell_type({2, 1}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 2}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 3}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({1, 2}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({3, 2}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({4, 2}, qca_technology::cell_type::OUTPUT);

    layout.assign_cell_name({0, 2}, "a");
    layout.assign_cell_name({2, 4}, "b");
    layout.assign_cell_name({4, 2}, "f");

    static const std::string qcad_layout = fmt::format("[VERSION]\n"
                                                       "qcadesigner_version=2.000000\n"
                                                       "[#VERSION]\n"
                                                       "[LAYOUT]\n"
                                                       "name=AND\n"
                                                       "generated_by={}\n"
                                                       "repo={}\n"
                                                       "[#LAYOUT]\n"
                                                       "[TYPE:DESIGN]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=3\n"
                                                       "status=1\n"
                                                       "pszDescription=Drawing Layer\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=0\n"
                                                       "status=1\n"
                                                       "pszDescription=Substrate\n"
                                                       "[TYPE:QCADSubstrate]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=3000.000000\n"
                                                       "y=1500.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=0.000000\n"
                                                       "bounding_box.yWorld=0.000000\n"
                                                       "bounding_box.cxWorld=6000.000000\n"
                                                       "bounding_box.cyWorld=3000.000000\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "grid_spacing=20.000000\n"
                                                       "[#TYPE:QCADSubstrate]\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=1\n"
                                                       "status=0\n"
                                                       "pszDescription=Ground Layer\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=100.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=32768\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=91.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_FIXED\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=95.500000\n"
                                                       "diameter=5\n"
                                                       "charge=0.000000e+00\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=104.500000\n"
                                                       "diameter=5\n"
                                                       "charge=1.602176e-19\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=104.500000\n"
                                                       "diameter=5\n"
                                                       "charge=0.000000e+00\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=95.500000\n"
                                                       "diameter=5\n"
                                                       "charge=1.602176e-19\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=78.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=32768\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=67.000000\n"
                                                       "bounding_box.cxWorld=54.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=-1.00\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=120.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=111.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=115.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=124.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=124.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=115.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=100.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=91.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_INPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=104.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=104.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=95.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=95.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=100.000000\n"
                                                       "y=118.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=91.000000\n"
                                                       "bounding_box.yWorld=107.000000\n"
                                                       "bounding_box.cxWorld=14.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=a\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=120.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=111.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=124.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=124.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=115.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=115.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=160.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=151.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=164.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=164.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=155.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=155.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=180.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=171.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_OUTPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=184.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=184.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=175.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=175.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=180.000000\n"
                                                       "y=118.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=171.000000\n"
                                                       "bounding_box.yWorld=107.000000\n"
                                                       "bounding_box.cxWorld=14.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=f\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=160.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=151.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=155.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=164.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=164.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=155.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=180.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=171.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_INPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=175.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=184.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=184.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=175.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=158.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=147.000000\n"
                                                       "bounding_box.cxWorld=14.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=b\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[#TYPE:DESIGN]\n",
                                                       FICTION_VERSION, FICTION_REPO);

    std::ostringstream layout_stream{};

    write_qca_layout(layout, layout_stream, {false});

    CHECK(layout_stream.str() == qcad_layout);
}

TEST_CASE("Write wire crossing", "[qcad]")
{
    using qca_layout = cell_level_layout<qca_technology, clocked_layout<cartesian_layout<offset::ucoord_t>>>;

    qca_layout layout{{4, 4, 1}, "Crossover"};

    layout.assign_cell_type({0, 2, 0}, qca_technology::cell_type::INPUT);
    layout.assign_cell_type({2, 0, 0}, qca_technology::cell_type::INPUT);
    layout.assign_cell_type({1, 2, 0}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 2, 0}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({3, 2, 0}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 1, 1}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 2, 1}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 3, 1}, qca_technology::cell_type::NORMAL);
    layout.assign_cell_type({2, 4, 0}, qca_technology::cell_type::OUTPUT);
    layout.assign_cell_type({4, 2, 0}, qca_technology::cell_type::OUTPUT);

    layout.assign_cell_mode({2, 1, 1}, qca_technology::cell_mode::CROSSOVER);
    layout.assign_cell_mode({2, 2, 1}, qca_technology::cell_mode::CROSSOVER);
    layout.assign_cell_mode({2, 3, 1}, qca_technology::cell_mode::CROSSOVER);

    layout.assign_cell_name({0, 2}, "a");
    layout.assign_cell_name({2, 0}, "b");
    layout.assign_cell_name({4, 2}, "a'");
    layout.assign_cell_name({2, 4}, "b'");

    static const std::string qcad_layout = fmt::format("[VERSION]\n"
                                                       "qcadesigner_version=2.000000\n"
                                                       "[#VERSION]\n"
                                                       "[LAYOUT]\n"
                                                       "name=Crossover\n"
                                                       "generated_by={}\n"
                                                       "repo={}\n"
                                                       "[#LAYOUT]\n"
                                                       "[TYPE:DESIGN]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=3\n"
                                                       "status=1\n"
                                                       "pszDescription=Drawing Layer\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=0\n"
                                                       "status=1\n"
                                                       "pszDescription=Substrate\n"
                                                       "[TYPE:QCADSubstrate]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=3000.000000\n"
                                                       "y=1500.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=0.000000\n"
                                                       "bounding_box.yWorld=0.000000\n"
                                                       "bounding_box.cxWorld=6000.000000\n"
                                                       "bounding_box.cyWorld=3000.000000\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "grid_spacing=20.000000\n"
                                                       "[#TYPE:QCADSubstrate]\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=1\n"
                                                       "status=0\n"
                                                       "pszDescription=Ground Layer\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=100.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=91.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_INPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=95.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=104.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=104.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=95.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=78.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=67.000000\n"
                                                       "bounding_box.cxWorld=14.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=b\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=100.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=91.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_INPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=104.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=104.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=95.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=95.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=100.000000\n"
                                                       "y=118.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=0\n"
                                                       "clr.blue=65535\n"
                                                       "bounding_box.xWorld=91.000000\n"
                                                       "bounding_box.yWorld=107.000000\n"
                                                       "bounding_box.cxWorld=14.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=a\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=120.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=111.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=124.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=124.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=115.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=115.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=160.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=151.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=164.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=164.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=155.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=155.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=180.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=171.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_OUTPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=184.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=184.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=175.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=175.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=180.000000\n"
                                                       "y=118.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=171.000000\n"
                                                       "bounding_box.yWorld=107.000000\n"
                                                       "bounding_box.cxWorld=24.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=a'\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=180.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=171.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_NORMAL\n"
                                                       "cell_function=QCAD_CELL_OUTPUT\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=175.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=184.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=184.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=175.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=-319472243083548083355648.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:QCADLabel]\n"
                                                       "[TYPE:QCADStretchyObject]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=158.500000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=65535\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=147.000000\n"
                                                       "bounding_box.cxWorld=24.000000\n"
                                                       "bounding_box.cyWorld=23\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "[#TYPE:QCADStretchyObject]\n"
                                                       "psz=b'\n"
                                                       "[#TYPE:QCADLabel]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[TYPE:QCADLayer]\n"
                                                       "type=1\n"
                                                       "status=0\n"
                                                       "pszDescription=Crossing Layer 1\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=120.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=111.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_CROSSOVER\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=115.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=124.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=124.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=115.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=140.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=131.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_CROSSOVER\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=144.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=135.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[TYPE:QCADCell]\n"
                                                       "[TYPE:QCADDesignObject]\n"
                                                       "x=140.000000\n"
                                                       "y=160.000000\n"
                                                       "bSelected=FALSE\n"
                                                       "clr.red=0\n"
                                                       "clr.green=65535\n"
                                                       "clr.blue=0\n"
                                                       "bounding_box.xWorld=131.000000\n"
                                                       "bounding_box.yWorld=151.000000\n"
                                                       "bounding_box.cxWorld=18\n"
                                                       "bounding_box.cyWorld=18\n"
                                                       "[#TYPE:QCADDesignObject]\n"
                                                       "cell_options.cxCell=18\n"
                                                       "cell_options.cyCell=18\n"
                                                       "cell_options.dot_diameter=5\n"
                                                       "cell_options.clock=0\n"
                                                       "cell_options.mode=QCAD_CELL_MODE_CROSSOVER\n"
                                                       "cell_function=QCAD_CELL_NORMAL\n"
                                                       "number_of_dots=4\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=155.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=144.500000\n"
                                                       "y=164.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=164.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[TYPE:CELL_DOT]\n"
                                                       "x=135.500000\n"
                                                       "y=155.500000\n"
                                                       "diameter=5\n"
                                                       "charge=8.010882e-20\n"
                                                       "spin=0.000000\n"
                                                       "potential=0.000000\n"
                                                       "[#TYPE:CELL_DOT]\n"
                                                       "[#TYPE:QCADCell]\n"
                                                       "[#TYPE:QCADLayer]\n"
                                                       "[#TYPE:DESIGN]\n",
                                                       FICTION_VERSION, FICTION_REPO);

    SECTION("Using specific function")
    {

        std::ostringstream layout_stream{};

        write_qca_layout(layout, layout_stream, {true});

        CHECK(layout_stream.str() == qcad_layout);
    }
    SECTION("Using general function")
    {
        std::ostringstream layout_stream{};

        write_qca_layout(layout, layout_stream);

        CHECK(layout_stream.str() == qcad_layout);
    }
}
